# Refactored-TikTok

ä¸€ä¸ªåŸºäºå¾®æœåŠ¡æ¶æ„çš„é«˜æ€§èƒ½çŸ­è§†é¢‘å¹³å°ï¼Œä½¿ç”¨ CloudWeGo ç”Ÿæ€ç³»ç»Ÿï¼ˆKitex + Hertzï¼‰æ„å»ºï¼Œå®ç°äº†å®Œæ•´çš„ TikTok åŠŸèƒ½ã€‚

## ğŸš€ é¡¹ç›®ç‰¹è‰²

- **å¾®æœåŠ¡æ¶æ„**: åŸºäº Kitex RPC æ¡†æ¶çš„åˆ†å¸ƒå¼å¾®æœåŠ¡è®¾è®¡
- **é«˜æ€§èƒ½**: ä½¿ç”¨ Hertz HTTP æ¡†æ¶æä¾›é«˜æ€§èƒ½ API ç½‘å…³
- **äº‹ä»¶é©±åŠ¨**: å®ç°äº‹ä»¶é©±åŠ¨çš„æ•°æ®åŒæ­¥æœºåˆ¶ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§
- **åˆ†å¸ƒå¼å­˜å‚¨**: æ”¯æŒ MySQL åˆ†åº“åˆ†è¡¨ã€Redis ç¼“å­˜ã€MinIO å¯¹è±¡å­˜å‚¨
- **æ¶ˆæ¯é˜Ÿåˆ—**: é›†æˆ RabbitMQ å®ç°å¼‚æ­¥æ¶ˆæ¯å¤„ç†
- **æœåŠ¡å‘ç°**: åŸºäº etcd çš„æœåŠ¡æ³¨å†Œä¸å‘ç°
- **é“¾è·¯è¿½è¸ª**: é›†æˆ Jaeger åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
- **å®¹å™¨åŒ–éƒ¨ç½²**: å®Œæ•´çš„ Docker Compose éƒ¨ç½²æ–¹æ¡ˆ

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Frontend  â”‚    â”‚  Mobile Client  â”‚    â”‚   Admin Panel   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      API Gateway          â”‚
                    â”‚      (Hertz)              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   User    â”‚         â”‚    Video      â”‚       â”‚  Interaction  â”‚
    â”‚ Service   â”‚         â”‚   Service     â”‚       â”‚   Service     â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Relation  â”‚         â”‚   Message     â”‚       â”‚               â”‚
    â”‚ Service   â”‚         â”‚   Service     â”‚       â”‚               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Infrastructure         â”‚
                    â”‚  MySQL | Redis | MinIO    â”‚
                    â”‚  RabbitMQ | etcd | Jaeger â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### åç«¯æ¡†æ¶
- **[Kitex](https://github.com/cloudwego/kitex)**: é«˜æ€§èƒ½ RPC æ¡†æ¶
- **[Hertz](https://github.com/cloudwego/hertz)**: é«˜æ€§èƒ½ HTTP æ¡†æ¶
- **[Thrift](https://thrift.apache.org/)**: IDL å®šä¹‰å’Œä»£ç ç”Ÿæˆ

### æ•°æ®å­˜å‚¨
- **MySQL**: ä¸»æ•°æ®åº“ï¼Œæ”¯æŒåˆ†åº“åˆ†è¡¨
- **Redis**: ç¼“å­˜å’Œä¼šè¯å­˜å‚¨
- **MinIO**: å¯¹è±¡å­˜å‚¨æœåŠ¡

### ä¸­é—´ä»¶
- **RabbitMQ**: æ¶ˆæ¯é˜Ÿåˆ—
- **etcd**: æœåŠ¡æ³¨å†Œä¸å‘ç°
- **Jaeger**: åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
- **Elasticsearch**: æ—¥å¿—èšåˆå’Œæœç´¢


## ğŸ“ é¡¹ç›®ç»“æ„

```
Refactored-TikTok/
â”œâ”€â”€ cmd/                    # å¾®æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ api/               # API ç½‘å…³æœåŠ¡
â”‚   â”œâ”€â”€ user/              # ç”¨æˆ·æœåŠ¡
â”‚   â”œâ”€â”€ video/             # è§†é¢‘æœåŠ¡
â”‚   â”œâ”€â”€ interaction/       # äº’åŠ¨æœåŠ¡ï¼ˆç‚¹èµã€è¯„è®ºï¼‰
â”‚   â”œâ”€â”€ relation/          # å…³ç³»æœåŠ¡ï¼ˆå…³æ³¨ã€ç²‰ä¸ï¼‰
â”‚   â”œâ”€â”€ message/           # æ¶ˆæ¯æœåŠ¡
â”‚   â””â”€â”€ model/             # æ•°æ®æ¨¡å‹
â”œâ”€â”€ config/                # é…ç½®æ–‡ä»¶
â”œâ”€â”€ docs/                  # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ idl/                   # Thrift IDL å®šä¹‰
â”œâ”€â”€ kitex_gen/             # Kitex ç”Ÿæˆä»£ç 
â”œâ”€â”€ pkg/                   # å…¬å…±åŒ…
â”œâ”€â”€ scripts/               # éƒ¨ç½²è„šæœ¬
â””â”€â”€ video_recommendation/  # æ¨èç®—æ³•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Go 1.24.4+
- Docker & Docker Compose
- MySQL 8.0+
- Redis 6.0+
- etcd 3.5+

### 1. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/your-username/Refactored-TikTok.git
cd Refactored-TikTok
```

### 2. é…ç½®ç¯å¢ƒ

å¤åˆ¶é…ç½®æ–‡ä»¶å¹¶ä¿®æ”¹ç›¸å…³é…ç½®ï¼š

```bash
cp config/config.yml.example config/config.yml
# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®æ•°æ®åº“è¿æ¥ç­‰ä¿¡æ¯
```

### 3. å¯åŠ¨åŸºç¡€è®¾æ–½

```bash
# å¯åŠ¨ MySQL, Redis, etcd, RabbitMQ ç­‰æœåŠ¡
docker-compose up -d mysql redis etcd rabbitmq minio jaeger
```

### 4. æ•°æ®åº“åˆå§‹åŒ–

```bash
# åˆ›å»ºæ•°æ®åº“å’Œè¡¨ç»“æ„
mysql -h localhost -u root -p < data/init.sql
```

### 5. ç”Ÿæˆä»£ç 

```bash
# ç”Ÿæˆ Kitex RPC ä»£ç 
chmod +x kitex_gen.sh
./kitex_gen.sh

# ç”Ÿæˆ Hertz HTTP ä»£ç 
chmod +x hertz_gen.sh
./hertz_gen.sh
```

### 6. æ„å»ºå’Œå¯åŠ¨æœåŠ¡

```bash
# æ„å»ºæ‰€æœ‰æœåŠ¡
make build

# å¯åŠ¨æ‰€æœ‰å¾®æœåŠ¡
docker-compose up -d
```

### 7. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:8080/ping

# æŸ¥çœ‹æœåŠ¡æ³¨å†Œæƒ…å†µ
curl http://localhost:2379/v2/keys/kitex
```

## ğŸ“– API æ–‡æ¡£

### ç”¨æˆ·ç›¸å…³
- `POST /douyin/user/register/` - ç”¨æˆ·æ³¨å†Œ
- `POST /douyin/user/login/` - ç”¨æˆ·ç™»å½•
- `GET /douyin/user/` - è·å–ç”¨æˆ·ä¿¡æ¯

### è§†é¢‘ç›¸å…³
- `GET /douyin/feed/` - è§†é¢‘æµ
- `POST /douyin/publish/action/` - è§†é¢‘å‘å¸ƒ
- `GET /douyin/publish/list/` - å‘å¸ƒåˆ—è¡¨

### äº’åŠ¨ç›¸å…³
- `POST /douyin/favorite/action/` - ç‚¹èµæ“ä½œ
- `GET /douyin/favorite/list/` - ç‚¹èµåˆ—è¡¨
- `POST /douyin/comment/action/` - è¯„è®ºæ“ä½œ
- `GET /douyin/comment/list/` - è¯„è®ºåˆ—è¡¨

### ç¤¾äº¤ç›¸å…³
- `POST /douyin/relation/action/` - å…³æ³¨æ“ä½œ
- `GET /douyin/relation/follow/list/` - å…³æ³¨åˆ—è¡¨
- `GET /douyin/relation/follower/list/` - ç²‰ä¸åˆ—è¡¨

è¯¦ç»† API æ–‡æ¡£è¯·å‚è€ƒ [API Documentation](docs/api.md)

## ğŸ”§ é…ç½®è¯´æ˜

ä¸»è¦é…ç½®æ–‡ä»¶ä½äº `config/config.yml`ï¼š

```yaml
server:
  name: "douyin"
  host: "0.0.0.0"
  port: 8080

mysql:
  host: "localhost"
  port: 3306
  database: "douyin"
  username: "root"
  password: "password"

redis:
  host: "localhost"
  port: 6379
  password: ""
  db: 0

etcd:
  addr: "localhost:2379"
```

## ğŸ—ï¸ å¾®æœåŠ¡è¯¦è§£

### API Gateway (Hertz)
- ç»Ÿä¸€å…¥å£ï¼Œè·¯ç”±åˆ†å‘
- èº«ä»½è®¤è¯å’Œæˆæƒ
- é™æµå’Œç†”æ–­
- è¯·æ±‚æ—¥å¿—è®°å½•

### User Service
- ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
- ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- JWT Token ç”Ÿæˆå’ŒéªŒè¯

### Video Service
- è§†é¢‘ä¸Šä¼ å’Œå­˜å‚¨
- è§†é¢‘ä¿¡æ¯ç®¡ç†
- è§†é¢‘æ¨èç®—æ³•
- è§†é¢‘è½¬ç å¤„ç†

### Interaction Service
- ç‚¹èµåŠŸèƒ½
- è¯„è®ºç³»ç»Ÿ
- äº‹ä»¶é©±åŠ¨çš„æ•°æ®åŒæ­¥

### Relation Service
- å…³æ³¨/å–æ¶ˆå…³æ³¨
- ç²‰ä¸å…³ç³»ç®¡ç†
- å¥½å‹æ¨è

### Message Service
- ç§ä¿¡åŠŸèƒ½
- æ¶ˆæ¯æ¨é€
- èŠå¤©è®°å½•

## ğŸ”„ äº‹ä»¶é©±åŠ¨æ¶æ„

é¡¹ç›®å®ç°äº†å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ•°æ®åŒæ­¥æœºåˆ¶ï¼š

1. **ç«‹å³å“åº”**: Redis ç¼“å­˜æä¾›å¿«é€Ÿç”¨æˆ·åé¦ˆ
2. **å¼‚æ­¥å¤„ç†**: æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æ•°æ®åº“æ“ä½œ
3. **å¹‚ç­‰æ€§ä¿è¯**: é˜²æ­¢é‡å¤å¤„ç†
4. **äº‹åŠ¡ä¸€è‡´æ€§**: æ•°æ®åº“æ“ä½œä½¿ç”¨äº‹åŠ¡
5. **ç›‘æ§å‘Šè­¦**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ [äº‹ä»¶é©±åŠ¨åŒæ­¥æ–‡æ¡£](docs/EVENT_DRIVEN_SYNC.md)

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

- **ç¼“å­˜ç­–ç•¥**: å¤šçº§ç¼“å­˜ï¼Œçƒ­ç‚¹æ•°æ®é¢„åŠ è½½
- **æ•°æ®åº“ä¼˜åŒ–**: è¯»å†™åˆ†ç¦»ï¼Œåˆ†åº“åˆ†è¡¨
- **è¿æ¥æ± **: æ•°æ®åº“å’Œ Redis è¿æ¥æ± ä¼˜åŒ–
- **å¼‚æ­¥å¤„ç†**: éæ ¸å¿ƒä¸šåŠ¡å¼‚æ­¥åŒ–

## ğŸ” ç›‘æ§å’Œè¿ç»´

### æ—¥å¿—ç®¡ç†
- ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- æ—¥å¿—çº§åˆ«æ§åˆ¶
- ELK æ—¥å¿—èšåˆ

### é“¾è·¯è¿½è¸ª
- Jaeger åˆ†å¸ƒå¼è¿½è¸ª
- æ€§èƒ½ç“¶é¢ˆåˆ†æ
- é”™è¯¯é“¾è·¯å®šä½

### å¥åº·æ£€æŸ¥
- æœåŠ¡å¥åº·çŠ¶æ€ç›‘æ§
- è‡ªåŠ¨æ•…éšœè½¬ç§»
- æœåŠ¡é™çº§ç­–ç•¥

